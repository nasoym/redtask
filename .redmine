#!/bin/bash


function current_sprint_id() {
  curl -s -3 "https://$SERVER/projects/$PROJECT_ID/versions.json?key=$KEY" |\
  jq '(.versions[] | select( .status == "open") | .id)'
}

function current_user_id() {
  curl -s -3 "https://$SERVER/users/current.json?key=$KEY" |\
  jq '.user.id'
}

#function current() {
#  SPRINT_ID=$(current_sprint_id)
#  #curl -s -3 "https://$SERVER/issues.json?key=$KEY&limit=$ISSUE_LIMIT&project_id=$PROJECT_ID&tracker_id=2&status_id=open&fixed_version_id=$SPRINT_ID" |\
#  curl -s -3 "https://$SERVER/issues.json?key=$KEY&limit=$ISSUE_LIMIT&project_id=$PROJECT_ID&status_id=open&fixed_version_id=$SPRINT_ID" |\
#  jq '.issues[] | .id'
#}

function current() {
  local SPRINT_ID=$(current_sprint_id)
  ALL=$(curl -s -3 "https://$SERVER/issues.json?key=$KEY&limit=$ISSUE_LIMIT&project_id=$PROJECT_ID&status_id=open&fixed_version_id=$SPRINT_ID&sort=status:desc" |\
  jq -c '.issues[]')

  local OLD_IFS="$IFS"
  local IFS=$'\n'
  local IFS=${IFS:0:1}
  local ALL_LINES_ARRAY=(${ALL})
  local IFS=$OLD_IFS
  local ALL_JSON="["
  local FIRST_ELEMENT=1
  for JSON in "${ALL_LINES_ARRAY[@]}"; do
    if [ "$FIRST_ELEMENT" -eq 1 ];then
      FIRST_ELEMENT=0
      ALL_JSON="${ALL_JSON}${JSON}"
    else
      ALL_JSON="${ALL_JSON},${JSON}"
    fi
  done
  ALL_JSON="$ALL_JSON]"

  local NO_PARENT="$(echo "$ALL_JSON" | jq -c '[.[] | select(has("parent")|not)]')"
  local WITH_PARENT="$(echo "$ALL_JSON" | jq -c '[.[] | select(has("parent"))]')"
  local IDS_WITH_PARENT="$(echo "$WITH_PARENT" | jq '.[]|.id')"
  local IDS_NO_PARENT="$(echo "$NO_PARENT" | jq '.[]|.id')"

  for ID in $IDS_WITH_PARENT; do
    JSON="$(echo "$WITH_PARENT" | jq -r ".[]| select(.id==$ID)")"
    PARENT="$(echo "$JSON" | jq '.parent.id')"
    NO_PARENT="$(echo "$NO_PARENT" | jq -c "[.[] | if .id==$PARENT then .children+=[$JSON] else . end]")"
  done

  ALL_TASKS_JSON="$NO_PARENT"
  IDS="$IDS_NO_PARENT"
  #echo "$IDS_NO_PARENT"
}

#function current_user() {
#  SPRINT_ID=$(current_sprint_id)
#  USER_ID=$(current_user_id)
#  curl -s -3 "https://$SERVER/issues.json?key=$KEY&limit=$ISSUE_LIMIT&project_id=$PROJECT_ID&tracker_id=2&status_id=open&fixed_version_id=$SPRINT_ID&assigned_to_id=$USER_ID" |\
#  jq '.issues[] | .id'
#}
#
#function backlog() {
#  SPRINT_ID=$(current_sprint_id)
#  curl -s -3 "https://$SERVER/issues.json?key=$KEY&limit=$ISSUE_LIMIT&project_id=$PROJECT_ID&tracker_id=2&status_id=open&fixed_version_id=!$SPRINT_ID" |\
#  jq '.issues[] | .id'
#}
#
#function backlog_user() {
#  SPRINT_ID=$(current_sprint_id)
#  curl -s -3 "https://$SERVER/issues.json?key=$KEY&limit=$ISSUE_LIMIT&project_id=$PROJECT_ID&tracker_id=2&status_id=open&fixed_version_id=!$SPRINT_ID&assigned_to_id=$USER_ID" |\
#  jq '.issues[] | .id'
#}
#
#
